<!DOCTYPE html>
<html>
<head>
    <title>Windows TTS Config - Talker</title>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>
<body>
    <div id="app">
        <v-app>
            <app-header current-page="windows"></app-header>

            <v-main>
                <v-container>
                    <v-card class="mx-auto" max-width="800">
                        <v-card-title>Configuración de Windows TTS</v-card-title>
                        <v-card-text>
                            <v-form @submit.prevent="saveConfig">
                                <v-select
                                    v-model="config.audioDevice"
                                    :items="audioDevices"
                                    item-text="name"
                                    item-value="id"
                                    label="Dispositivo de Audio"
                                    outlined
                                    @click="loadAudioDevices"
                                ></v-select>

                                <v-btn
                                    color="primary"
                                    type="submit"
                                    :loading="saving"
                                    class="mt-4"
                                >
                                    Guardar Configuración
                                </v-btn>
                            </v-form>

                            <v-divider class="my-4"></v-divider>

                            <v-card-title>Prueba de Voz</v-card-title>
                            <v-textarea
                                v-model="testText"
                                label="Texto para prueba"
                                outlined
                            ></v-textarea>

                            <v-btn
                                color="success"
                                @click="testVoice"
                                :loading="testing"
                                class="mb-4"
                            >
                                Probar Voz
                            </v-btn>
                        </v-card-text>
                    </v-card>
                </v-container>
            </v-main>

            <v-snackbar v-model="snackbar.show" :color="snackbar.color">
                {{ snackbar.text }}
                <template v-slot:action="{ attrs }">
                    <v-btn text v-bind="attrs" @click="snackbar.show = false">
                        Cerrar
                    </v-btn>
                </template>
            </v-snackbar>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="/components/header.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify({
                theme: {
                    dark: localStorage.getItem('theme') === 'dark'
                }
            }),
            data: () => ({
                saving: false,
                testing: false,
                testText: '',
                audioDevices: [],
                config: {
                    audioDevice: ''
                },
                snackbar: {
                    show: false,
                    text: '',
                    color: 'success'
                }
            }),
            mounted() {
                this.loadConfig();
                this.loadAudioDevices();
            },
            methods: {
                async loadAudioDevices() {
                    try {
                        const response = await fetch('/api/config/audio-devices');
                        const data = await response.json();
                        if (data.success) {
                            this.audioDevices = data.devices;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.showSnackbar('Error al cargar dispositivos de audio', 'error');
                    }
                },
                async loadConfig() {
                    try {
                        const response = await fetch('/api/config');
                        const data = await response.json();
                        if (data.success) {
                            this.config = data.config;
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        this.showSnackbar('Error al cargar la configuración', 'error');
                    }
                },
                async saveConfig() {
                    this.saving = true;
                    try {
                        const response = await fetch('/api/config', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.config)
                        });
                        
                        if (!response.ok) {
                            throw new Error('Error al guardar la configuración');
                        }
                        
                        this.showSnackbar('Configuración guardada exitosamente');
                    } catch (error) {
                        console.error('Error:', error);
                        this.showSnackbar('Error al guardar la configuración', 'error');
                    }
                    this.saving = false;
                },
                async testVoice() {
                    if (!this.testText) {
                        this.showSnackbar('Ingrese texto para la prueba', 'error');
                        return;
                    }

                    this.testing = true;
                    try {
                        const response = await fetch('/api/tts/test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                text: this.testText,
                                audioDevice: this.config.audioDevice
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Error al generar audio');
                        }

                        this.showSnackbar('Audio generado exitosamente');
                    } catch (error) {
                        console.error('Error:', error);
                        this.showSnackbar('Error al probar la voz', 'error');
                    }
                    this.testing = false;
                },
                showSnackbar(text, color = 'success') {
                    this.snackbar.text = text;
                    this.snackbar.color = color;
                    this.snackbar.show = true;
                }
            }
        });
    </script>
</body>
</html>
